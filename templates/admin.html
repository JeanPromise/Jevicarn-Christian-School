{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-blue-900">⚡ Admin Control — Jevicarn</h1>
      {% if logged_in %}
      <form method="post" action="{{ url_for('admin_logout') }}">
        <button class="px-3 py-1 bg-red-500 text-white rounded text-sm">Logout</button>
      </form>
      {% endif %}
    </div>

    {% if register_mode %}
      <!-- One-time registration -->
      <div class="max-w-md mx-auto p-6 bg-green-50 rounded-lg shadow">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-4">
              {% for category, msg in messages %}
                <div class="mb-2 px-3 py-2 rounded {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-800' }}">{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        <form method="post" action="{{ url_for('admin_register') }}">
          <label class="block mb-2 font-semibold">Username</label>
          <input name="username" class="w-full p-2 rounded border" required />
          <label class="block mt-4 mb-2 font-semibold">Password</label>
          <input name="password" type="password" class="w-full p-2 rounded border" required />
          <label class="block mt-4 mb-2 font-semibold">Confirm</label>
          <input name="password2" type="password" class="w-full p-2 rounded border" required />
          <div class="mt-4 text-right"><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Create Admin</button></div>
        </form>
      </div>

    {% elif not logged_in %}
      <!-- Login -->
      <div class="max-w-md mx-auto p-6 bg-blue-50 rounded-lg shadow">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-4">
              {% for category, msg in messages %}
                <div class="mb-2 px-3 py-2 rounded {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-800' }}">{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        <form method="post" action="{{ url_for('admin_login') }}">
          <label class="block mb-2 font-semibold">Username</label>
          <input name="username" class="w-full p-2 rounded border" required />
          <label class="block mt-4 mb-2 font-semibold">Password</label>
          <input name="password" type="password" class="w-full p-2 rounded border" required />
          <div class="mt-4 text-right"><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Log in</button></div>
        </form>
      </div>

    {% else %}
      <!-- ADMIN ACTION UI -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- VISITORS PANEL -->
        <section class="lg:col-span-1 bg-white p-4 rounded-lg border shadow-sm">
          <h2 class="text-lg font-semibold mb-2">Visitors / Users</h2>
          <p class="text-sm text-gray-600 mb-3">Recent visitors and message counts (admin-only).</p>

          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="p-3 rounded border bg-gray-50 text-center">
              <div class="text-xs text-gray-500">Total messages</div>
              <div class="font-bold text-lg">{{ total_msgs or 0 }}</div>
            </div>
            <div class="p-3 rounded border bg-gray-50 text-center">
              <div class="text-xs text-gray-500">Unique users</div>
              <div class="font-bold text-lg">{{ total_users or 0 }}</div>
            </div>
          </div>

          <div class="overflow-auto max-h-64">
            <table class="min-w-full text-left text-sm">
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th class="px-3 py-2">User</th>
                  <th class="px-3 py-2">Messages</th>
                  <th class="px-3 py-2">Platform</th>
                </tr>
              </thead>
              <tbody>
                {% for s in top_senders %}
                <tr class="border-b">
                  <td class="px-3 py-2">{{ s[0] }}</td>
                  <td class="px-3 py-2">{{ s[1] }}</td>
                  <td class="px-3 py-2">—</td>
                </tr>
                {% endfor %}
                {% for v in visitors %}
                <tr class="border-b">
                  <td class="px-3 py-2">{{ v.name }}</td>
                  <td class="px-3 py-2">—</td>
                  <td class="px-3 py-2">{{ v.platform }}</td>
                </tr>
                {% endfor %}
                {% if not top_senders and not visitors %}
                <tr><td colspan="3" class="px-3 py-6 text-gray-500 text-center">No visitor data yet.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </section>

        <!-- GALLERY PANEL (center) -->
        <section class="lg:col-span-2 bg-white p-4 rounded-lg border shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Gallery — manage images</h2>
            <div class="text-sm text-gray-500">Select one image to Replace or Delete. Select many to Delete.</div>
          </div>

          <!-- upload new -->
          <form id="uploadForm" method="post" action="{{ url_for('admin_gallery_upload') }}" enctype="multipart/form-data" class="mb-4">
            <div class="flex gap-2">
              <input type="file" name="file" accept="image/*" required class="p-2 border rounded w-1/3" />
              <input name="caption" placeholder="Caption (optional)" class="p-2 border rounded flex-1" />
              <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded">Add image</button>
            </div>
          </form>

          <!-- action toolbar -->
          <div class="flex items-center gap-3 mb-3">
            <button id="syncExistingBtn" class="px-3 py-2 bg-indigo-600 text-white rounded text-sm">Sync existing static images</button>
            <button id="deleteSelectedBtn" class="px-3 py-2 bg-red-600 text-white rounded disabled:opacity-60" disabled>Delete selected</button>
            <button id="replaceSelectedBtn" class="px-3 py-2 bg-yellow-500 text-white rounded disabled:opacity-60" disabled>Replace selected</button>
            <div class="ml-auto text-xs text-gray-500">Tip: click image to toggle selection</div>
          </div>

          <!-- gallery grid -->
          <div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            {% if gallery_items %}
              {% for it in gallery_items %}
              <div class="relative border rounded p-2 flex flex-col items-stretch" data-id="{{ it.id }}">
                <label class="cursor-pointer">
                  <input type="checkbox" class="card-check sr-only" data-id="{{ it.id }}">
                  <img src="{{ url_for('uploaded_file', filename=it.filename) }}" alt="" class="w-full h-40 object-cover rounded select-none" />
                </label>

                <div class="mt-2 flex items-center justify-between gap-2">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm text-gray-700 truncate">{{ it.caption or '—' }}</div>
                    <div class="text-xs text-gray-500">{{ it.created_at }}</div>
                  </div>
                  <div class="flex flex-col gap-2 ml-2">
                    <button data-id="{{ it.id }}" class="single-replace-btn px-3 py-1 bg-yellow-500 text-white rounded text-sm">Replace</button>
                    <button data-id="{{ it.id }}" class="single-delete-btn px-3 py-1 bg-red-600 text-white rounded text-sm">Delete</button>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="text-gray-500 p-6">No images uploaded yet.</div>
            {% endif %}
          </div>
        </section>
      </div>

      <!-- REPLACE MODAL -->
      <div id="replaceModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
        <div class="bg-white rounded-lg p-4 w-full max-w-md">
          <h3 class="font-semibold mb-2">Replace image</h3>
          <form id="replaceForm">
            <input type="hidden" id="replace_target_id" name="id" />
            <div class="mb-2">
              <input id="replace_file" type="file" name="file" accept="image/*" required class="w-full" />
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="replaceCancel" class="px-3 py-1 rounded border">Cancel</button>
              <button type="submit" class="px-3 py-1 bg-yellow-600 text-white rounded">Replace</button>
            </div>
          </form>
        </div>
      </div>

      <!-- toast -->
      <div id="toast" class="fixed right-6 bottom-6 hidden p-3 rounded shadow text-sm"></div>

    {% endif %}
  </div>
</div>

{% if logged_in %}
<script>
/* Minimal, friendly JS to support selection + single/multi actions */
/* Utility: toast */
function toast(msg, ok=true){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = '';
  el.classList.add('fixed','right-6','bottom-6','p-3','rounded','shadow','text-sm');
  el.classList.add(ok ? 'bg-green-100' : 'bg-red-100');
  el.style.display = 'block';
  setTimeout(()=> el.style.display = 'none', 3000);
}

/* Selection logic */
const galleryGrid = document.getElementById('galleryGrid');
const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
const replaceSelectedBtn = document.getElementById('replaceSelectedBtn');
const syncExistingBtn = document.getElementById('syncExistingBtn');
let selected = new Set();

function updateToolbar(){
  const n = selected.size;
  deleteSelectedBtn.disabled = n === 0;
  replaceSelectedBtn.disabled = n !== 1;
}

/* Toggle checkbox when clicking card image */
galleryGrid?.addEventListener('click', (e) => {
  // find the card element
  const card = e.target.closest('[data-id]');
  if(!card) return;
  // if user clicked the individual action buttons, let those handlers run
  if(e.target.closest('.single-delete-btn') || e.target.closest('.single-replace-btn') || e.target.closest('button')) return;

  const id = card.getAttribute('data-id');
  const checkbox = card.querySelector('.card-check');
  if(!checkbox) return;
  checkbox.checked = !checkbox.checked;
  if(checkbox.checked) selected.add(id); else selected.delete(id);
  card.classList.toggle('ring-2', checkbox.checked);
  updateToolbar();
});

/* Keep selected state when user clicks the visible checkboxes */
galleryGrid?.querySelectorAll('.card-check')?.forEach(cb => {
  cb.addEventListener('change', (e) => {
    const id = cb.getAttribute('data-id');
    const card = cb.closest('[data-id]');
    if(cb.checked) { selected.add(id); card.classList.add('ring-2'); }
    else { selected.delete(id); card.classList.remove('ring-2'); }
    updateToolbar();
  });
});

/* Single-delete button */
galleryGrid?.addEventListener('click', async (e) => {
  const btn = e.target.closest('.single-delete-btn');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  if(!confirm('Delete this image?')) return;
  try {
    const res = await fetch('{{ url_for("admin_gallery_delete_ajax") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: id })
    });
    const payload = await res.json();
    if(res.ok && payload.success){
      document.querySelector(`[data-id="${id}"]`)?.remove();
      selected.delete(id);
      updateToolbar();
      toast('Image deleted');
    } else {
      toast('Delete failed', false);
    }
  } catch(err){ console.error(err); toast('Delete request failed', false); }
});

/* Single-replace button */
galleryGrid?.addEventListener('click', (e) => {
  const btn = e.target.closest('.single-replace-btn');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  openReplaceModal(id);
});

/* Delete selected (many) */
deleteSelectedBtn?.addEventListener('click', async () => {
  if(selected.size === 0) { toast('No images selected', false); return; }
  if(!confirm(`Delete ${selected.size} image(s)?`)) return;
  const ids = Array.from(selected);
  for(const id of ids){
    try{
      const res = await fetch('{{ url_for("admin_gallery_delete_ajax") }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id: id })
      });
      const payload = await res.json();
      if(res.ok && payload.success){
        document.querySelector(`[data-id="${id}"]`)?.remove();
        selected.delete(id);
      } else {
        toast('Failed to delete some items', false);
      }
    } catch(err){
      console.error(err);
      toast('Delete requests failed', false);
      break;
    }
  }
  updateToolbar();
  toast('Selected deletes processed');
});

/* Replace selected (only when exactly one selected) */
replaceSelectedBtn?.addEventListener('click', () => {
  if(selected.size !== 1) { toast('Select exactly one image to replace', false); return; }
  const id = Array.from(selected)[0];
  openReplaceModal(id);
});

/* Replace modal */
const replaceModal = document.getElementById('replaceModal');
const replaceForm = document.getElementById('replaceForm');
function openReplaceModal(id){
  document.getElementById('replace_target_id').value = id;
  document.getElementById('replace_file').value = '';
  replaceModal.classList.remove('hidden');
  replaceModal.classList.add('flex');
}
function closeReplaceModal(){
  replaceModal.classList.add('hidden');
  replaceModal.classList.remove('flex');
}
document.getElementById('replaceCancel')?.addEventListener('click', closeReplaceModal);

/* Replace submit */
replaceForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('replace_target_id').value;
  const fileInput = document.getElementById('replace_file');
  if(!fileInput.files.length) { toast('Choose a file', false); return; }
  const fd = new FormData();
  fd.append('id', id);
  fd.append('file', fileInput.files[0]);
  try {
    const resp = await fetch('{{ url_for("admin_gallery_replace_ajax") }}', { method: 'POST', body: fd });
    const data = await resp.json();
    if(resp.ok && data.success){
      // update the image src in the card
      const card = document.querySelector(`[data-id="${id}"]`);
      if(card){
        const img = card.querySelector('img');
        if(img) img.src = '/uploads/' + data.filename + '?t=' + Date.now();
      }
      closeReplaceModal();
      toast('Image replaced');
    } else {
      toast('Replace failed', false);
    }
  } catch(err){ console.error(err); toast('Replace request failed', false); }
});

/* Sync existing static images -> gallery DB */
syncExistingBtn?.addEventListener('click', async () => {
  if(!confirm('Scan static/uploads for files and import any missing images into the gallery DB?')) return;
  try{
    const res = await fetch('/admin/gallery/sync', { method: 'POST' });
    const data = await res.json();
    if(res.ok && data.success){
      toast(`Imported ${data.imported} image(s)`);
      setTimeout(()=> location.reload(), 700);
    } else {
      toast('Sync failed', false);
      console.error(data);
    }
  } catch(err){
    console.error(err);
    toast('Sync request failed', false);
  }
});

/* keyboard: escape closes modal */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closeReplaceModal();
});

/* init toolbar state */
updateToolbar();
</script>
{% endif %}
{% endblock %}
