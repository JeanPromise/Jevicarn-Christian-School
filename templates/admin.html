{% extends 'base.html' %}
{% block content %}
<meta http-equiv="refresh" content="90"> <!-- Fallback in case JS stops -->
<style>
  body {
    background-color: #f7faff;
    font-family: 'Segoe UI', Tahoma, sans-serif;
  }

  .admin-container {
    max-width: 1000px;
    margin: 40px auto;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .admin-header {
    background: linear-gradient(135deg, #0d47a1, #1565c0);
    color: #fff;
    text-align: center;
    padding: 16px;
    font-size: 1.25em;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .admin-chat-area {
    display: flex;
    height: 75vh;
  }

  .chat-list {
    width: 30%;
    background: #e3f2fd;
    border-right: 1px solid #c5cae9;
    overflow-y: auto;
  }

  .chat-list-item {
    padding: 14px 16px;
    border-bottom: 1px solid #cfd8dc;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s;
  }

  .chat-list-item:hover { background-color: #bbdefb; }
  .chat-list-item.active {
    background-color: #90caf9;
    font-weight: bold;
    color: #0d47a1;
  }

  .chat-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #f4f8ff;
    position: relative;
  }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 18px;
    display: flex;
    flex-direction: column;
  }

  .message {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 18px;
    margin-bottom: 10px;
    font-size: 0.96rem;
    line-height: 1.4;
    word-wrap: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .user-msg {
    background: #0288d1;
    color: #fff;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }

  .admin-msg {
    background: #0d47a1;
    color: #fff;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  .timestamp {
    font-size: 0.75rem;
    color: #ccc;
    margin-top: 4px;
    text-align: right;
  }

  .reply-form {
    display: flex;
    gap: 10px;
    padding: 12px;
    background: #fff;
    border-top: 1px solid #ddd;
    align-items: center;
  }

  .reply-form input {
    flex: 1;
    padding: 10px 16px;
    border-radius: 25px;
    border: 1px solid #ccc;
    outline: none;
  }

  .reply-form input:focus {
    border-color: #0d47a1;
    box-shadow: 0 0 3px rgba(13,71,161,0.3);
  }

  .reply-form button {
    background: #0d47a1;
    border: none;
    color: #fff;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-size: 1.2rem;
    cursor: pointer;
    transition: 0.2s;
  }

  .reply-form button:hover { background: #08306b; }

  .no-messages {
    color: #777;
    text-align: center;
    margin-top: 20%;
    font-size: 1.1rem;
  }
</style>

<section class="admin-container">
  <div class="admin-header">üë©‚Äçüè´ Jevicarn Christian School - Admin Chat Center</div>

  <div class="admin-chat-area">
    <!-- Sender list -->
    <div class="chat-list">
      {% for sender in senders %}
        <a href="{{ url_for('admin', auth=request.args.get('auth'), sender=sender) }}"
           style="text-decoration:none; color:inherit;">
          <div class="chat-list-item {% if sender == active_sender %}active{% endif %}">
            {{ sender }}
          </div>
        </a>
      {% else %}
        <div class="no-messages">No messages yet</div>
      {% endfor %}
    </div>

    <!-- Chat box -->
    <div class="chat-box">
      <div class="messages">
        {% if chat_messages %}
          {% for msg in chat_messages %}
            <div class="message {{ 'admin-msg' if msg.sender == 'admin' else 'user-msg' }}">
              {% if msg.text %}
                <div>{{ msg.text }}</div>
              {% endif %}
              {% if msg.filename %}
                <a href="{{ url_for('uploaded_file', filename=msg.filename) }}" target="_blank" style="color:#fff;text-decoration:underline;">üìé Attachment</a>
              {% endif %}
              <div class="timestamp">{{ msg.timestamp }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-messages">Select a user to view conversation</div>
        {% endif %}
      </div>

      {% if active_sender %}
        <form method="POST"
              action="{{ url_for('admin_reply', sender=active_sender) }}?auth={{ request.args.get('auth','') }}"
              class="reply-form">
          <input type="text" name="text" placeholder="Type your reply..." required>
          <button title="Send">üì§</button>
        </form>
      {% endif %}
    </div>
  </div>
</section>

<script>
  const senderActive = "{{ active_sender }}";
  const authKey = "{{ request.args.get('auth', '') }}";
  const messagesBox = document.querySelector('.messages');
  let lastCount = document.querySelectorAll('.message').length;

  function scrollToBottom() {
    messagesBox.scrollTop = messagesBox.scrollHeight;
  }
  scrollToBottom();

  if (senderActive) {
    setInterval(() => {
      fetch(`/admin?auth=${authKey}&sender=${senderActive}`)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const newDoc = parser.parseFromString(html, "text/html");
          const newMessages = newDoc.querySelector('.messages');
          const newCount = newMessages.querySelectorAll('.message').length;

          if (newCount > lastCount) {
            const ding = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_3fdd2a153b.mp3?filename=ding-36029.mp3");
            ding.play();
          }

          lastCount = newCount;
          messagesBox.innerHTML = newMessages.innerHTML;
          scrollToBottom();
        })
        .catch(err => console.error("Auto-refresh failed:", err));
    }, 6000);
  }
</script>
{% endblock %}
