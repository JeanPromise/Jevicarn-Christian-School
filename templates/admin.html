{% extends 'base.html' %}
{% block content %}
<style>
  /* Hide site header/hero/footer that come from base.html so admin is uncluttered */
  header, .site-header, nav, .hero, .masthead, .topbar, footer, .site-footer {
    display: none !important;
  }

  /* Admin container tweaks */
  .admin-wrapper { max-width: 1200px; margin: 0 auto; }
  /* Thumbnails: consistent small squares */
  .thumb-img { width:100%; height:110px; object-fit:cover; border-radius:8px; display:block; }
  .card-check:focus + img { outline: 2px solid #60a5fa; }
  .thumb-card { transition: box-shadow .12s, transform .08s; }
  .thumb-card.ring { box-shadow: 0 0 0 3px rgba(99,102,241,.12); transform: translateY(-2px); }
  /* spinner overlay */
  .uploader-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60; background:rgba(0,0,0,.35); }
  .spinner { width:48px; height:48px; border-radius:50%; border:6px solid rgba(255,255,255,.15); border-top-color:white; animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg);} }

  /* lightbox */
  .lightbox { position: fixed; inset:0; display:none; z-index:70; align-items:center; justify-content:center; background: rgba(0,0,0,.85); }
  .lightbox img { max-width:92%; max-height:88%; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.6); }
  .lightbox .close, .lightbox .nav { position: absolute; color:white; font-size:30px; cursor:pointer; user-select:none; }
  .lightbox .close { top:18px; right:28px; }
  .lightbox .nav.left { left:18px; top:50%; transform:translateY(-50%); }
  .lightbox .nav.right { right:18px; top:50%; transform:translateY(-50%); }
  /* small helpers */
  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
</style>

<div class="min-h-screen bg-gray-50 p-6 admin-wrapper">
  <div class="bg-white p-6 rounded-2xl shadow">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold text-sky-800">⚡ Admin — Gallery Manager</h1>
      {% if logged_in %}
      <form method="post" action="{{ url_for('admin_logout') }}">
        <button class="px-3 py-1 bg-red-600 text-white rounded text-sm">Logout</button>
      </form>
      {% endif %}
    </div>

    {% if register_mode %}
      <div class="max-w-md mx-auto p-6 bg-green-50 rounded-lg shadow">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-4">
              {% for category, msg in messages %}
                <div class="mb-2 px-3 py-2 rounded {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-800' }}">{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        <form method="post" action="{{ url_for('admin_register') }}">
          <label class="block mb-2">Username</label>
          <input name="username" class="w-full p-2 rounded border" required />
          <label class="block mt-4 mb-2">Password</label>
          <input name="password" type="password" class="w-full p-2 rounded border" required />
          <label class="block mt-4 mb-2">Confirm</label>
          <input name="password2" type="password" class="w-full p-2 rounded border" required />
          <div class="mt-4 text-right"><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Create Admin</button></div>
        </form>
      </div>

    {% elif not logged_in %}
      <div class="max-w-md mx-auto p-6 bg-blue-50 rounded-lg shadow">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-4">
              {% for category, msg in messages %}
                <div class="mb-2 px-3 py-2 rounded {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-800' }}">{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        <form method="post" action="{{ url_for('admin_login') }}">
          <label class="block mb-2">Username</label>
          <input name="username" class="w-full p-2 rounded border" required />
          <label class="block mt-4 mb-2">Password</label>
          <input name="password" type="password" class="w-full p-2 rounded border" required />
          <div class="mt-4 text-right"><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Log in</button></div>
        </form>
      </div>

    {% else %}
      <!-- toolbar -->
      <div class="flex gap-3 items-center mb-4">
        <form id="uploadForm" method="post" action="{{ url_for('admin_gallery_upload') }}" enctype="multipart/form-data" class="flex gap-2 items-center">
          <label class="bg-sky-600 text-white px-3 py-2 rounded cursor-pointer">
            <input id="upload_input" type="file" name="file" accept="image/*" class="sr-only" required>
            Upload
          </label>
          <input id="upload_caption" name="caption" placeholder="Caption (optional)" class="p-2 border rounded" />
          <button id="uploadBtn" type="button" class="px-3 py-2 bg-blue-600 text-white rounded">Add</button>
        </form>

        <button id="syncExistingBtn" class="px-3 py-2 bg-indigo-600 text-white rounded text-sm">Sync existing static images</button>

        <div class="ml-auto flex gap-2 items-center">
          <button id="deleteSelectedBtn" class="px-3 py-2 bg-red-600 text-white rounded disabled:opacity-60" disabled>Delete selected</button>
          <button id="replaceSelectedBtn" class="px-3 py-2 bg-yellow-500 text-white rounded disabled:opacity-60" disabled>Replace selected</button>
        </div>
      </div>

      <!-- grid -->
      <div id="galleryGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
        {% if gallery_items %}
          {% for it in gallery_items %}
          <div class="thumb-card border rounded p-1 bg-white" data-id="{{ it.id }}" data-fname="{{ it.filename }}">
            <label class="cursor-pointer block relative">
              <input class="card-check sr-only" type="checkbox" data-id="{{ it.id }}">
              <img class="thumb-img" src="{{ url_for('uploaded_file', filename=it.filename) }}" alt="thumb-{{ it.id }}" loading="lazy">
            </label>
            <div class="mt-2 flex items-center justify-between gap-2">
              <div class="text-xs text-gray-700 truncate">{{ it.caption or '—' }}</div>
              <div class="flex flex-col gap-1 ml-2">
                <button data-id="{{ it.id }}" class="single-replace-btn px-2 py-0.5 bg-yellow-500 text-white rounded text-xs">Replace</button>
                <button data-id="{{ it.id }}" class="single-delete-btn px-2 py-0.5 bg-red-600 text-white rounded text-xs">Delete</button>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-gray-500 p-6">No images uploaded yet.</div>
        {% endif %}
      </div>

      <!-- uploader overlay spinner -->
      <div id="uploaderOverlay" class="uploader-overlay">
        <div>
          <div class="spinner"></div>
        </div>
      </div>

      <!-- lightbox -->
      <div id="lightbox" class="lightbox">
        <span class="close" title="close">&times;</span>
        <span class="nav left" title="previous">&#10094;</span>
        <img id="lightboxImg" src="" alt="preview">
        <span class="nav right" title="next">&#10095;</span>
      </div>
    {% endif %}
  </div>
</div>

{% if logged_in %}
<script>
/* -------------------------
  Admin gallery JS (friendly)
   - small thumbnails
   - clicking thumb opens lightbox
   - Replace button -> file chooser -> AJAX upload with spinner
   - Upload form uses XHR with progress spinner
   - Multi-delete works
---------------------------*/

/* helpers */
const toast = (msg, ok=true) => {
  // minimal toast using alert fallback
  try {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = '';
    t.classList.add('fixed','right-6','bottom-6','p-3','rounded','shadow','text-sm');
    t.classList.add(ok ? 'bg-green-100' : 'bg-red-100');
    t.style.display = 'block';
    setTimeout(()=> t.style.display='none', 2800);
  } catch(e){ console.log(msg); }
};
const overlay = document.getElementById('uploaderOverlay');
function showSpinner(){ overlay && (overlay.style.display='flex'); }
function hideSpinner(){ overlay && (overlay.style.display='none'); }

/* selection */
const galleryGrid = document.getElementById('galleryGrid');
let selected = new Set();
const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
const replaceSelectedBtn = document.getElementById('replaceSelectedBtn');
const syncExistingBtn = document.getElementById('syncExistingBtn');

function updateToolbar(){
  const n = selected.size;
  deleteSelectedBtn.disabled = n === 0;
  replaceSelectedBtn.disabled = n !== 1;
}

/* click on card: toggle selection unless clicking a button */
galleryGrid?.addEventListener('click', (e) => {
  const card = e.target.closest('[data-id]');
  if(!card) return;
  // ignore if a control button was clicked
  if(e.target.closest('button')) return;
  const id = card.getAttribute('data-id');
  const checkbox = card.querySelector('.card-check');
  if(!checkbox) return;
  checkbox.checked = !checkbox.checked;
  if(checkbox.checked){ selected.add(id); card.classList.add('ring'); }
  else { selected.delete(id); card.classList.remove('ring'); }
  updateToolbar();
});

/* checkbox change handlers */
galleryGrid?.querySelectorAll('.card-check')?.forEach(cb => {
  cb.addEventListener('change', (e) => {
    const id = cb.getAttribute('data-id');
    const card = cb.closest('[data-id]');
    if(cb.checked){ selected.add(id); card.classList.add('ring'); }
    else { selected.delete(id); card.classList.remove('ring'); }
    updateToolbar();
  });
});

/* single-delete and delete-selected using AJAX endpoint */
galleryGrid?.addEventListener('click', async (e) => {
  const btn = e.target.closest('.single-delete-btn');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  if(!confirm('Delete this image?')) return;
  try{
    showSpinner();
    const res = await fetch('{{ url_for("admin_gallery_delete_ajax") }}', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id: id })
    });
    const data = await res.json();
    hideSpinner();
    if(res.ok && data.success){
      document.querySelector(`[data-id="${id}"]`)?.remove();
      selected.delete(id);
      updateToolbar();
      toast('Image deleted');
    } else {
      toast('Delete failed', false);
    }
  } catch(err){
    hideSpinner();
    console.error(err); toast('Delete request failed', false);
  }
});

deleteSelectedBtn?.addEventListener('click', async () => {
  if(selected.size === 0){ toast('No images selected', false); return; }
  if(!confirm(`Delete ${selected.size} image(s)?`)) return;
  const ids = Array.from(selected);
  showSpinner();
  for(const id of ids){
    try{
      const res = await fetch('{{ url_for("admin_gallery_delete_ajax") }}', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: id })
      });
      const data = await res.json();
      if(res.ok && data.success){ document.querySelector(`[data-id="${id}"]`)?.remove(); selected.delete(id); }
    } catch(e){ console.error(e); }
  }
  hideSpinner();
  updateToolbar();
  toast('Selected deletes processed');
});

/* ---------------- Replace: immediate file chooser per card ----------------
   We'll create a single hidden file input to reuse; when Replace clicked we set currentId and trigger click.
   On file selection we send XHR (so we can show upload progress) to /admin/gallery/replace_ajax
-------------------------------------------------------------------------*/
let replaceTargetId = null;
const hiddenReplaceInput = document.createElement('input');
hiddenReplaceInput.type = 'file';
hiddenReplaceInput.accept = 'image/*';
hiddenReplaceInput.style.display = 'none';
document.body.appendChild(hiddenReplaceInput);

galleryGrid?.addEventListener('click', (e) => {
  const btn = e.target.closest('.single-replace-btn');
  if(!btn) return;
  replaceTargetId = btn.getAttribute('data-id');
  hiddenReplaceInput.value = ''; // reset
  hiddenReplaceInput.click();
});

hiddenReplaceInput.addEventListener('change', async () => {
  if(!hiddenReplaceInput.files.length) return;
  const file = hiddenReplaceInput.files[0];
  const fd = new FormData();
  fd.append('id', replaceTargetId);
  fd.append('file', file);

  // XHR to show progress
  const xhr = new XMLHttpRequest();
  xhr.open('POST', '{{ url_for("admin_gallery_replace_ajax") }}', true);
  xhr.onloadstart = () => { showSpinner(); };
  xhr.upload.onprogress = (ev) => {
    // optional: you could show percent; we keep simple spinner
  };
  xhr.onreadystatechange = () => {
    if(xhr.readyState === 4){
      hideSpinner();
      try {
        const res = JSON.parse(xhr.responseText || '{}');
        if(xhr.status >= 200 && xhr.status < 300 && res.success){
          // update thumbnail src
          const card = document.querySelector(`[data-id="${replaceTargetId}"]`);
          if(card){
            const img = card.querySelector('img');
            if(img) img.src = '/uploads/' + res.filename + '?t=' + Date.now();
          }
          toast('Image replaced');
        } else {
          toast('Replace failed', false);
          console.error(res);
        }
      } catch(err){
        console.error(err); toast('Unexpected response', false);
      }
    }
  };
  xhr.send(fd);
});

/* Replace selected toolbar: open file chooser too */
replaceSelectedBtn?.addEventListener('click', () => {
  if(selected.size !== 1){ toast('Select exactly one image to replace', false); return; }
  replaceTargetId = Array.from(selected)[0];
  hiddenReplaceInput.value = '';
  hiddenReplaceInput.click();
});

/* ---------------- Upload form: intercept to use XHR with spinner ---------------- */
const uploadInput = document.getElementById('upload_input');
const uploadCaption = document.getElementById('upload_caption');
const uploadBtn = document.getElementById('uploadBtn');

uploadBtn?.addEventListener('click', () => uploadInput.click());

uploadInput?.addEventListener('change', () => {
  if(!uploadInput.files.length) return;
  const file = uploadInput.files[0];
  const fd = new FormData();
  fd.append('file', file);
  fd.append('caption', uploadCaption.value || '');

  const xhr = new XMLHttpRequest();
  xhr.open('POST', '{{ url_for("admin_gallery_upload") }}', true);
  xhr.onloadstart = () => showSpinner();
  xhr.upload.onprogress = (ev) => {
    // we keep spinner — could show percent if desired
  };
  xhr.onreadystatechange = () => {
    if(xhr.readyState === 4){
      hideSpinner();
      if(xhr.status >= 200 && xhr.status < 400){
        // successful upload causes a redirect in normal flow; but here app returns redirect.
        // Reload admin page to show new image (simple and reliable).
        toast('Uploaded — refreshing');
        setTimeout(()=> location.reload(), 600);
      } else {
        toast('Upload failed', false);
        console.error(xhr.responseText);
      }
    }
  };
  xhr.send(fd);
});

/* ---------------- Lightbox preview ---------------- */
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightboxImg');
const lbClose = lightbox?.querySelector('.close');
const lbPrev = lightbox?.querySelector('.nav.left');
const lbNext = lightbox?.querySelector('.nav.right');

let lbIndex = -1;
function buildImageList(){
  const cards = Array.from(document.querySelectorAll('[data-id]'));
  return cards.map(c => {
    const id = c.getAttribute('data-id');
    const img = c.querySelector('img');
    return { id, src: img?.src, el: c };
  });
}
function openLightboxBySrc(src){
  const list = buildImageList();
  lbIndex = list.findIndex(i => i.src === src);
  if(lbIndex < 0) lbIndex = 0;
  lightboxImg.src = list[lbIndex].src;
  lightbox.style.display = 'flex';
}
galleryGrid?.addEventListener('click', (e) => {
  // if user clicked the image itself (not the card overall or button)
  if(e.target.tagName === 'IMG'){
    openLightboxBySrc(e.target.src);
  }
});
lbClose?.addEventListener('click', ()=> lightbox.style.display='none');
lbPrev?.addEventListener('click', ()=> {
  const list = buildImageList();
  lbIndex = (lbIndex - 1 + list.length) % list.length;
  lightboxImg.src = list[lbIndex].src;
});
lbNext?.addEventListener('click', ()=> {
  const list = buildImageList();
  lbIndex = (lbIndex + 1) % list.length;
  lightboxImg.src = list[lbIndex].src;
});
document.addEventListener('keydown', (e) => {
  if(lightbox.style.display === 'flex'){
    if(e.key === 'Escape') lightbox.style.display='none';
    if(e.key === 'ArrowLeft') lbPrev.click();
    if(e.key === 'ArrowRight') lbNext.click();
  }
});

/* ---------------- Sync existing static images ---------------- */
syncExistingBtn?.addEventListener('click', async () => {
  if(!confirm('Scan static/uploads and import any missing images into gallery DB?')) return;
  try{
    showSpinner();
    const res = await fetch('{{ url_for("admin_gallery_sync") }}', { method:'POST' });
    const data = await res.json();
    hideSpinner();
    if(res.ok && data.success){
      toast(`Imported ${data.imported} images`);
      setTimeout(()=> location.reload(), 700);
    } else {
      toast('Sync failed', false);
      console.error(data);
    }
  } catch(err){
    hideSpinner();
    console.error(err); toast('Sync request failed', false);
  }
});

/* init */
updateToolbar();
</script>
{% endif %}
{% endblock %}
